/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.SitePage=b.UserPage.extend({params:{},regions:{},phones:[],initConfig:function(){b.backUrl="../sites/sites.html",document.location.search&&(this.params=b.parseParams(document.location.search),this.params.id&&(document.getElementById("site_id").value=this.params.id))},initPage:function(c){this._super();var d=this;b.showWaiting(),d.phones.push(b.User.get_phone()),b.Api.get_site_list(b.User.get_user_id(),function(b){if(a.isArray(b.data))for(var c=b.data,e=0,f=c.length;f>e;e++)d.phones.push(c[e].consignee_phone)}),b.Api.get_location(function(c){if(c.data&&a.isArray(c.data)&&c.data.length){d.regions={};for(var e=0,f=c.data.length;f>e;e++){var g=c.data[e],h={value:g.id,text:g.name,children:[]};0==g.pguid&&(d.regions[h.value]=h)}for(var e=0,f=c.data.length;f>e;e++){var g=c.data[e],h={value:g.id,text:g.name,children:[]};g.pguid>0&&d.regions[g.pguid]&&d.regions[g.pguid].children.push(h)}d.cityPicker=new a.PopPicker({layer:2}),d.cityPicker.setData(d.regions)}b.closeWaiting()},function(){b.closeWaiting()})},initEvent:function(){var c=this;document.getElementById("save").addEventListener("tap",function(){c.save()}),document.getElementById("consignee_phone").addEventListener("blur",function(){this.value&&(this.value!=b.User.get_phone()?document.getElementById("sms_group").classList.remove("mui-hidden"):document.getElementById("sms_group").classList.add("mui-hidden"))}),document.getElementById("get_sms").addEventListener("tap",function(){var a=this;if(!a.busying){var d=c.checkPhone();d!=b.User.get_phone()&&d&&(a.busying=!0,a.innerText="正在发送中",b.Api.get_sms(4,d,b.User.get_user_id(),function(b){c.countSms(a)},function(){b.error("获取验证码失败，请重试"),a.innerText="获取验证码"}))}}),a("#site").on("tap","#geolocation",function(){c.get_address()}),document.getElementById("region_select").addEventListener("tap",function(){c.cityPicker.show(function(a){a[1]?(document.getElementById("region_name").value=a[0].text+" - "+a[1].text,document.getElementById("city_id").value=a[0].value,document.getElementById("region_id").value=a[1].value):(document.getElementById("region_name").value=a[0].text,document.getElementById("city_id").value=a[0].value,document.getElementById("region_id").value=a[0].value)})})},save:function(){var a=this,c=document.getElementById("site_id").value,d=document.getElementById("city_id").value,e=document.getElementById("region_id").value,f=document.getElementById("address").value,g=document.getElementById("consignee_name").value,h=document.getElementById("consignee_phone").value,i=document.getElementById("sms").value;if(!d)return void b.alert("请选择城市");if(!e)return void b.alert("请选择城区");if(!f)return void b.alert("请填写详细地址");if(!g)return void b.alert("请填写您的姓名");if(!/^1[3|4|5|8|7][0-9]\d{4,8}$/.test(h))return void b.alert("您输入的手机号码不符合格式，请重新输入！");if(~a.phones.indexOf(h))i="";else if(!/[0-9]{6}$/.test(i))return void b.alert("您输入的验证码不符合格式，请重新输入！");var j={user_id:b.User.get_user_id(),city_id:d,region_id:e,address:f,consignee_phone:h,consignee_name:g};i&&(j.sms=i),b.showWaiting(),c?(j.site_id=c,b.Api.edit_usersite(j,function(c){b.closeWaiting(),a.back()},function(){b.closeWaiting()})):b.Api.add_usersite(j,function(c){b.closeWaiting(),a.back()},function(){b.closeWaiting()})},back:function(){a.back()},countSms:function(a){var b=60,c=window.setInterval(function(){a.innerText=--b+"秒后重发",0>=b&&(window.clearInterval(c),a.busying=!1,a.innerText="获取验证码")},1e3)},checkPhone:function(){var a=document.getElementById("consignee_phone"),c=a.value;return/^1[3|4|5|8|7][0-9]\d{4,8}$/.test(c)?c:(a.value="",b.alert("您输入的手机号码不符合格式，请重新输入！"),setTimeout(function(){a.focus()},20),!1)},get_address:function(){b.showWaiting(),b.Location.getLocation(function(a){b.closeWaiting(),a&&(document.getElementById("address").value=a.address)})}})}(mui,TS),function(a,b){a.os.plus&&(b.SitePage=b.SitePage.extend({back:function(){a.fire(plus.webview.getWebviewById("sites"),"sites"),a.back()}}))}(mui,TS);