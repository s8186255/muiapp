/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.CartPage=b.UserPage.extend({params:{},carts:{},initConfig:function(){b.backUrl="../my/my.html",document.location.search&&(this.params=b.parseParams(document.location.search)),this.carts={},template.helper("priceFormat",function(a){return parseFloat(a).toFixed(2)})},initPage:function(c){this._super();var d=this;b.Api.get_carts(b.User.get_user_id(),b.Location.get_city_id(),function(e){if(b.template("cart","cart/cart",{cartData:e.data}),d.params.item_id){var f=document.querySelector('#cart li[data-item_id="'+d.params.item_id+'"] input[name="checkbox"]');f&&(f.checked=!0)&&a.trigger(f,"change")}d.initCart(e.data),c&&c()},function(){})},refresh:function(){var a=this;a.initPage(function(){a.calPrice()})},initCart:function(c){var d=this;c&&c.length&&a.each(c,function(a,c){d.carts[c.cart_id]=new b.CartClass(c)}),b.debug&&b.d(JSON.stringify(d.carts))},delete_cart:function(a){var c=this,d=a.getAttribute("data-id");b.showWaiting(),b.Api.delete_cart(b.User.get_user_id(),d,function(){delete c.carts[d],a.parentNode.removeChild(a),b.closeWaiting()},function(){b.closeWaiting()})},initEvent:function(){var c=this;a("#cart").on("tap",".mui-icon-trash",function(a){var d=this;return a.detail&&a.detail.isManual===!1?c.delete_cart(d.parentNode.parentNode):b.confirm("是否删除当前餐厅菜单？（PS：操作不可撤销）",function(a){a&&c.delete_cart(d.parentNode.parentNode)}),!1}),document.getElementById("confirm").addEventListener("tap",function(){var d=[],e=0,f=0,g=0,h=[],i=0;return a.each(document.querySelectorAll('#cart input[name="checkbox"]:checked'),function(a,b){var j=b.parentNode,k=j.getAttribute("data-id");d.push(k),c.carts[k]&&c.carts[k].changed&&h.push(c.carts[k].toObject()),e+=parseFloat(j.getAttribute("data-material_price")),f+=parseFloat(j.getAttribute("data-act_price")),g+=parseFloat(j.getAttribute("data-cart_service"));var l=parseInt(j.getAttribute("data-item_neartime"));l&&(i=Math.max(parseInt(l),i))}),d.length?b.Site.get_site()?void(h.length>0?(b.showWaiting(),b.Api.update_select_cart(b.User.get_user_id(),h,function(c){b.open("../confirmorder/confirmorder.html?"+a.param({cart_ids:d.join(","),material_price:e.toFixed(2),act_price:f.toFixed(2),cart_service:g.toFixed(2),item_time:i})),b.closeWaiting()},function(){b.closeWaiting()})):b.open("../confirmorder/confirmorder.html?"+a.param({cart_ids:d.join(","),material_price:e.toFixed(2),act_price:f.toFixed(2),cart_service:g.toFixed(2),item_time:i}))):void b.confirm("您尚未设置送餐地址！",function(a){a&&b.open("../sites/sites.html")}):void b.alert("请选择要结算的购物车")}),document.getElementById("checkall").addEventListener("change",function(){var a=this;c.setCheckAll(a.querySelector("input").checked,!0),c.calPrice()}),a("#cart").on("change",'input[type="checkbox"]',function(){var a=this;document.querySelector("#checkall input");c.setCheckAll(a.checked?document.querySelector('#cart input[type="checkbox"]:not(:checked)')?!1:!0:!1),c.calPrice()}),a("#cart").on("tap",".mui-numbox-btn-plus",function(){return c.addMaterial(this.parentNode),!1}),a("#cart").on("tap",".mui-numbox-btn-minus",function(){var d=this.parentNode,e=d.querySelector("input");return 1==e.value?b.confirm("是否删除当前菜品?",function(){c.removeMaterial(d);var b=d.parentNode,e=b.parentNode.parentNode;b.parentNode.removeChild(b),e.querySelector("li")||a.trigger(e.querySelector(".mui-icon-trash"),"tap",{isManual:!1})},function(){}):c.removeMaterial(this.parentNode),!1})},calPrice:function(){var b=0;return a.each(document.querySelectorAll('#cart input[name="checkbox"]:checked'),function(a,c){var d=c.parentNode;b+=parseFloat(d.getAttribute("data-material_price"))}),document.getElementById("price").innerText=b,b},setCheckAll:function(a,b){var c=document.getElementById("checkall"),d=c.querySelector("label"),e=c.querySelector("input");e.checked=a,a?(d.innerText="取消全选",b&&this.checkAll(!0)):(d.innerText="全选",b&&this.checkAll(!1))},checkAll:function(b){var c=document.querySelectorAll('#cart input[type="checkbox"]');a.each(c,function(a,c){c.checked=!!b})},addMaterial:function(a){this.changeMaterial(a,1)},removeMaterial:function(a){this.changeMaterial(a,-1)},changeMaterial:function(a,c){var d=a.querySelector("input"),e=a.parentNode.parentNode.parentNode,f=e.getAttribute("data-id"),g=a.getAttribute("data-id"),h=this.carts[f],i=h.addMaterial(g,c);return d.value=i,document.getElementById("price_"+f).innerText=h.material_price,e.setAttribute("data-material_price",h.material_price),this.calPrice(),0===h.materials.length&&(delete this.carts[f],b.debug&&b.d("cart["+f+"] removed")),h.changed=!0,i}})}(mui,TS),function(a){a.os.plus&&(TS.CartPage=TS.CartPage.extend(a.extend(TS.AppObject,{init:function(){this.initConfig(),this.initPage(function(){setTimeout(function(){TS.closeWaiting()},500)}),this.initEvent()},initConfig:function(){this._super(),a.plusReady(function(){plus.webview.currentWebview().setStyle({scrollIndicator:"none"})})},init5plusEvent:function(){var a=this;document.addEventListener("cart",function(b){a.refresh()})}})))}(mui);