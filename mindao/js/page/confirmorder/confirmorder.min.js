/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.ConfirmorderPage=b.UserPage.extend({params:{},coupon:{},minHour:0,back:function(){a.back()},initConfig:function(){var c=this;a.init({beforeback:function(){return b.confirm("是否放弃提交订单",function(b){b&&(a.options.beforeback=!1,c.back())}),!1}}),document.location.search&&(this.params=b.parseParams(document.location.search),this.params.item_id?b.backUrl="../supplier/supplier.html?id="+this.params.item_id:b.backUrl="../cart/cart.html",this.params.material_price=parseFloat(this.params.material_price),this.params.act_price=parseFloat(this.params.act_price),this.params.cart_service=parseFloat(this.params.cart_service)),b.Payment=new b.PaymentClass(b.data.payment)},initPage:function(){this._super();var a=this;a.initCoupon(),a.initDatePicker(),a.params.cart_ids?(a._initCart(),b.closeWaiting()):(b.showWaiting(),a.initCart(function(){a._initCart(),b.closeWaiting()})),b.User.isLogin()&&(document.getElementById("consignee_name").value=b.Site.get_consignee_name(),document.getElementById("phone").value=b.Site.get_consignee_phone(),document.getElementById("address").value=b.Site.get_address())},initCoupon:function(){var a=b.getItem("COUPON");if(a)try{this.coupon=JSON.parse(a)}catch(c){}var d=document.getElementById("coupon_desc");if(this.coupon&&this.coupon.coupon_id){var e=document.getElementById("coupon_id"),f=document.getElementById("coupon_num");e.value=this.coupon.coupon_id,f.value=this.coupon.coupon_value,e.checked=!0,d.innerText=this.coupon.coupon_name,d.classList.remove("mui-hidden")}else d.classList.add("mui-hidden")},_getDatetimeBegin:function(a){return a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()},_getDatetimeEnd:function(a){return a.setFullYear(a.getFullYear()+1),a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()},_getDatetimeHours:function(){return[{text:"12点-12点半",value:"12:00"},{text:"12点半-13点",value:"12:30"},{text:"13点-13点半",value:"13:00"},{text:"13点半-14点",value:"13:30"},{text:"14点-14点半",value:"14:00"},{text:"14点半-15点",value:"14:30"},{text:"15点-15点半",value:"15:00"},{text:"15点半-16点",value:"15:30"},{text:"16点-16点半",value:"16:00"},{text:"16点半-17点",value:"16:30"},{text:"17点-17点半",value:"17:00"},{text:"17点半-18点",value:"17:30"},{text:"18点-18点半",value:"18:00"},{text:"18点半-19点",value:"18:30"},{text:"19点-19点半",value:"19:00"},{text:"19点半-20点",value:"19:30"},{text:"20点-20点半",value:"20:00"},{text:"20点半-21点",value:"20:30"},{text:"21点-21点半",value:"21:00"},{text:"21点半-22点",value:"21:30"}]},timeSections:{"12:00":"12:00-12:30","12:30":"12:30-13:00","13:00":"13:00-13:30","13:30":"13:30-14:00","14:00":"14:00-14:30","14:30":"14:30-15:00","15:00":"15:00-15:30","15:30":"15:30-16:00","16:00":"16:00-16:30","16:30":"16:30-17:00","17:00":"17:00-17:30","17:30":"17:30-18:00","18:00":"18:00-18:30","18:30":"18:30-19:00","19:00":"19:00-19:30","19:30":"19:30-20:00","20:00":"20:00-20:30","20:30":"20:30-21:00","21:00":"21:00-21:30","21:30":"21:30-22:00"},_getTimesection:function(a){return this.timeSections[a]},initDatePicker:function(){var b=new Date;b.setHours(b.getHours()+(parseInt(this.minHour)||0));var c={type:"hour",begin:this._getDatetimeBegin(b),beginYear:b.getFullYear(),end:this._getDatetimeEnd(b),endYear:b.getFullYear(),customData:{h:this._getDatetimeHours()},labels:["年","月","日","时段","分"]};this.datePicker=new a.DtPicker(c)},_formatNumber:function(a){return a>9?a:"0"+a},initCart:function(c){var d=this;b.User.isLogin()&&(this.params.cart_ids||b.Api.get_carts(b.User.get_user_id(),b.Location.get_city_id(),this.params.item_id,!1,function(a){d.calCart(a.data),c&&c()},a.noop))},_initCart:function(){this.minHour=this.params.item_time;var a=parseFloat(this.params.material_price+this.params.act_price+this.params.cart_service).toFixed(2),b=document.getElementById("pay_count");b.payCount=a,b.innerText=a-parseFloat(document.getElementById("coupon_num").value),this.calDinnertime()},calDinnertime:function(){var a=this.datePicker.ui,b=new Date;b.setHours(b.getHours()+(parseInt(this.minHour)||0)),a.y.setSelectedValue(b.getFullYear(),!0),a.m.setSelectedValue(this._formatNumber(b.getMonth()+1),!0),a.d.setSelectedValue(this._formatNumber(b.getDate()),!0);var c=this._formatNumber(b.getHours())+":00";if(this.timeSections[c])a.h.setSelectedValue(c,!0);else{var d;for(var e in this.timeSections)if(!d){d=this.timeSections[e];break}parseInt(c)>22&&(b.setDate(b.getDate()+1),a.d.setSelectedValue(this._formatNumber(b.getDate()),!0)),a.h.setSelectedValue(d,!0)}},calCart:function(b){var c=this;if(c.params.cart_ids="",c.params.material_price=0,c.params.act_price=0,c.params.cart_service=0,a.isArray(b)&&b.length){var d=[];a.each(b,function(a,b){d.push(b.cart_id),b.item_neartime&&(c.minHour=Math.max(c.minHour,b.item_neartime)),c.params.material_price+=b.material_price,c.params.act_price+=b.act_price,c.params.cart_service+=b.cart_service}),c.params.cart_ids=d.join(",")}},openCoupon:function(a){b.open(a)},initEvent:function(){var c=this,d=document.getElementById("invoice"),e=document.getElementById("invoice_checkbox");e.addEventListener("change",function(){d.parentNode.classList[e.checked?"remove":"add"]("mui-hidden")}),document.getElementById("datetime").addEventListener("tap",function(){var a=this;a.focus(),c.datePicker.show(function(d){if(d&&d.value){var e=d.value.split(" "),f=e[0],g=e[1],h=new Date;h.setHours(h.getHours()+parseInt(c.minHour||0));var i=new Date((f+" "+g+":00").replace(/-/g,"/"));if(h>i)return b.alert("选择用餐时间需要在"+c.minHour+"小时后"),!1;var j=c._getTimesection(g);document.getElementById("dinner_time").value=f,document.getElementById("dinner_time_section").value=j,a.value=f+" "+j}})}),document.getElementById("coupont_open").addEventListener("tap",function(){document.getElementById("coupon_id").checked||c.openCoupon("../coupon/coupon.html?from="+encodeURIComponent(document.location.href))}),document.getElementById("offline").addEventListener("tap",function(){c.confirmOrder(2,0,function(a){b.open("../ordersuccess/ordersuccess.html?id="+a.data)},a.noop)}),document.getElementById("online").addEventListener("tap",function(){c.confirmOrder(1,0,function(a){var c=a.data,d=document.getElementById("pay_count").innerText;b.Payment.payAction({order_no:c,total:d,user_ip:"118.194.218.74"},function(a){a?(b.showWaiting(),b.Api.pay_order(c,1,d,function(a){b.closeWaiting(),b.open("../ordersuccess/ordersuccess.html?id="+c)},function(){b.closeWaiting(),b.open("../orderdetail/orderdetail.html?id="+c)})):b.open("../orderdetail/orderdetail.html?id="+c)})},a.noop)})},confirmOrder:function(a,c,d,e){var f=this,g={user_id:b.User.get_user_id(),site_id:b.Site.get_site_id(),station:b.Location.get_station_id(),distance_rank:b.Location.get_distance_rank(),cart_ids:this.params.cart_ids,material_sum:this.params.material_price,order_act:this.params.act_price,order_service:this.params.cart_service,pay_way:a,pay_channel:c,coupon_num:0},h=document.getElementById("coupon_id"),i=document.getElementById("coupon_num"),j=document.getElementById("people_num"),k=document.getElementById("dinner_time"),l=document.getElementById("dinner_time_section"),m=document.getElementById("invoice"),n=document.getElementById("has_tableware"),o=document.getElementById("remark");return h&&h.checked&&(g.coupon_id=h.value,g.coupon_num=parseFloat(i.value)),g.people_num=j.value,g.dinner_time=k.value,g.dinner_time_section=l.value,g.invoice=m.value,g.has_tableware=n.checked?1:2,g.remark="production"===b.env?o.value:"测试",g.people_num?g.dinner_time?g.dinner_time_section?(g.pay_count=g.material_sum+g.order_act+g.order_service-g.coupon_num,b.showWaiting(),void b.Api.cart_submit_order(g.user_id,g.site_id,g.station,g,function(a){b.closeWaiting(),g.coupon_id&&b.removeItem("COUPON"),f.cart_submit_order(),d&&d(a)},function(){b.closeWaiting(),e&&e()})):void b.alert("请输入用餐时段"):void b.alert("请输入用餐时间"):void b.alert("请输入用餐人数")},cart_submit_order:function(){}})}(mui,TS),function(a){a.os.plus&&(TS.ConfirmorderPage=TS.ConfirmorderPage.extend(a.extend(TS.AppObject,{back:function(){setTimeout(function(){TS.c(plus.webview.getWebviewById("supplier"))},400),a.back()},init:function(){this.initConfig();var b=this;a.plusReady(function(){plus.webview.currentWebview().setStyle({scrollIndicator:"none"}),b.initPage()}),this._init5plusEvent(),this.initEvent()},openCoupon:function(){TS.open("../coupon/coupon_main.html?from=confirmorder")},cart_submit_order:function(){if(!this.params.item_id){var b=plus.webview.getWebviewById("cart");b&&b.close("none")}var c=plus.webview.getWebviewById("order");c&&a.fire(c,"order_refresh")},init5plusEvent:function(){var a=this;document.addEventListener("refresh_coupon",function(b){a.initCoupon(),a._initCart()})}})))}(mui);