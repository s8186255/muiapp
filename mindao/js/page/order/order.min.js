/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.BasePage=a.Class.extend({navActive:"home",navData:b.data.nav,init:function(){this.initConfig(),this.initPage(),this.initEvent()},initConfig:function(){},initPage:function(){this.initNav()},initEvent:function(){},initNav:function(){var c=this.navData;if(b.IndexPage&&!a.os.plus)for(var d=0,e=c.length;e>d;d++){var f=c[d];"home"===f.id?f.url="index.html":f.url="page/"+f.id+"/"+f.id+".html"}b.template("nav","index/nav",{navData:c,index:this.navActive})}})}(mui,TS),function(a,b){b.OrderPage=b.BasePage.extend({navActive:"order",current:0,status:"all",initConfig:function(){b.Payment=new b.PaymentClass(b.data.payment),this.current=0,this.size=10},initPage:function(){this._super(),this.initPullRefresh();var b=this;a.ready(function(){b.refresh()})},goHome:function(){b.open("../../index.html")},initEvent:function(){var c=this;a(document.body).on("tap","#ts_filter_all",function(){c.filter("all")}),a(document.body).on("tap","#ts_filter_uncompleted",function(){c.filter("uncompleted")}),a(document.body).on("tap","#ts_filter_completed",function(){c.filter("completed")}),a("#tpl").on("tap",".ts-go-home",function(){c.goHome()}),a("#tpl").on("tap",".ts-order-cancel",function(b){return c.cancelOrder(this.getAttribute("data-id"),function(){a("#pullrefresh").pullRefresh().pulldownLoading()}),!1}),a("#tpl").on("tap",".ts-order-follow",function(a){return b.open(this.getAttribute("data-href")),!1}),a("#tpl").on("tap",".ts-order-pay",function(c){var d=this.getAttribute("data-id"),e=this.getAttribute("data-order_sum");return b.Payment.payAction({order_no:d,total:e,user_ip:"118.194.218.74"},function(c){c&&(b.showWaiting(),b.Api.pay_order(d,1,e,function(c){a("#pullrefresh").pullRefresh().pulldownLoading(),b.closeWaiting()},function(){a("#pullrefresh").pullRefresh().pulldownLoading(),b.closeWaiting()}))}),!1}),a("#tpl").on("tap","ul",function(a){b.open("../orderdetail/orderdetail.html?id="+this.getAttribute("data-id"))})},refresh:function(){this._refresh()},_refresh:function(){var c=a("#pullrefresh").pullRefresh();b.User.isLogin()?(c.setStopped(!1),c.pulldownLoading()):(c.setStopped(!0),this.createLoginPlaceHolder())},createLoginPlaceHolder:function(){var a=document.createElement("div");a.className="ts-placeholder ts-login-placeholder",a.innerHTML=document.getElementById("ts_login_placeholder").innerHTML,document.getElementById("tpl").innerHTML=a.outerHTML;var b=document.querySelector(".mui-pull-bottom-pocket");b&&b.classList.remove("mui-block")},createPlaceHolder:function(){var a=document.createElement("div");a.className="ts-placeholder",a.innerHTML=document.getElementById("ts_placeholder").innerHTML,document.getElementById("tpl").innerHTML=a.outerHTML;var b=document.querySelector(".mui-pull-bottom-pocket");b&&b.classList.remove("mui-block")},filter:function(a){this._filter(a)},_filter:function(b){this.status=b;var c=!1;a.each(document.querySelectorAll(".mui-table-view"),function(a,d){var e=d.getAttribute("data-status");"all"===b?(c=!0,d.classList.contains("mui-hidden")&&d.classList.remove("mui-hidden")):"uncompleted"===b?31!=e?(c=!0,d.classList.contains("mui-hidden")&&d.classList.remove("mui-hidden")):!d.classList.contains("mui-hidden")&&d.classList.add("mui-hidden"):"completed"===b&&(31==e?(c=!0,d.classList.contains("mui-hidden")&&d.classList.remove("mui-hidden")):!d.classList.contains("mui-hidden")&&d.classList.add("mui-hidden"))}),c?document.getElementById("pullrefresh").classList.remove("ts-noorder"):document.getElementById("pullrefresh").classList.add("ts-noorder")},renderOrder:function(a,c){b.template("tpl","order/order",{orderData:a.data},c);this.filter(this.status)},getOrder:function(a){var c=this;b.Api.get_order_list({user_id:b.User.get_user_id(),current:c.current,size:c.size},function(c){return c.return_code?void b.error(c.data):void(a&&a(c))})},initPullRefresh:function(){var c,d=this;document.getElementById("tpl");a.init({pullRefresh:{container:"#pullrefresh",down:{auto:!0,callback:function(){if(!b.User.isLogin())return d.createLoginPlaceHolder(),!c&&(c=a("#pullrefresh").pullRefresh()),void c.endPulldownToRefresh();var e=document.querySelector(".mui-pull-bottom-pocket");e&&e.classList.remove("mui-block"),d.current=0;var f=a.now();d.getOrder(function(e){var g=a.now()-f-500;setTimeout(function(){d.renderOrder(e),!c&&(c=a("#pullrefresh").pullRefresh()),c.endPulldownToRefresh(),e.total_count>(d.current+1)*d.size?c.refresh(!0):c.endPullupToRefresh(!0),b.debug&&b.d(d.current==="0|"+e.total_count===0),0===d.current&&0===e.total_count&&(d.createPlaceHolder(),c.setStopped(!0)),d.current++},g>0?0:-g)})}},up:{show:!1,callback:function(){return b.User.isLogin()?void d.getOrder(function(e){d.renderOrder(e,"append"),!c&&(c=a("#pullrefresh").pullRefresh()),c.endPullupToRefresh(!(e.total_count>(d.current+1)*d.size)),b.debug&&b.d(d.current==="0|"+e.total_count===0),0===d.current&&0===e.total_count?(d.createPlaceHolder(),c.setStopped(!0)):d.current++}):(d.createLoginPlaceHolder(),!c&&(c=a("#pullrefresh").pullRefresh()),void c.endPulldownToRefresh())}}}})},cancelOrder:function(c,d){b.User.isLogin()&&b.confirm("是否删除当前订单?",function(e){e&&(b.showWaiting(),b.Api.cancel_order(b.User.get_user_id(),c,function(a){b.closeWaiting(),d&&d()},a.noop))})}})}(mui,TS),function(a){a.os.plus&&(TS.OrderPage=TS.OrderPage.extend(a.extend(TS.AppObject,{initPage:function(){var b=this;a.plusReady(function(){"order"===plus.webview.currentWebview().id&&b.initPullRefresh()})},filter:function(b){a.fire(plus.webview.getWebviewById("order"),"filter",{type:b})},refresh:function(b){a.fire(plus.webview.getWebviewById("order"),"order_refresh",{type:b})},refresh2:function(b){a.fire(plus.webview.getWebviewById("order"),"order_refresh2",{type:b})},goHome:function(){a.fire(plus.webview.getLaunchWebview(),"goHome")},init5plusEvent:function(){var b=this;a.plusReady(function(){"order"===plus.webview.currentWebview().id?(document.addEventListener("order_refresh",function(a){b._refresh()}),document.addEventListener("order_refresh2",function(a){var c=!!document.querySelector("#tpl .ts-login-placeholder"),d=TS.User.isLogin(),e=!1;c?d&&(e=!0):d||(e=!0),TS.debug&&TS.d(c+"|"+d),e&&(TS.debug&&TS.d("order refresh"),b._refresh())}),document.addEventListener("filter",function(a){b._filter(a.detail.type)}),document.addEventListener("order",function(a){b._refresh()})):document.addEventListener("nav_order",function(a){a.detail.force===!1?(TS.debug&&TS.d("force:::false"),b.refresh2(document.querySelector(".mui-control-item.mui-active").getAttribute("data-type"))):(TS.debug&&TS.d("force:::true"),b.refresh(document.querySelector(".mui-control-item.mui-active").getAttribute("data-type")))})})}})))}(mui);