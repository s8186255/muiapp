/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.CouponPage=b.UserPage.extend({current:0,size:10,coupons:{},initConfig:function(){b.backUrl="../my/my.html",document.location.search&&(this.params=b.parseParams(document.location.search),this.params.from&&(b.backUrl=this.params.from)),this.current=0,this.size=10,template.helper("date",function(a){a=new Date(1e3*a);var b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate();return b+"-"+(c>9?c:"0"+c)+"-"+(d>9?d:"0"+d)})},initPage:function(a){this._super(),this.initPullRefresh()},refresh:function(){this._refresh()},_refresh:function(){var c=a("#pullrefresh").pullRefresh();b.User.isLogin()&&(c.setStopped(!1),c.pulldownLoading())},initEvent:function(){var c=this;a("#coupon").on("tap","li[data-id]",function(){var d=this.getAttribute("data-id"),e=this.getAttribute("data-expired");return"true"===e?(b.toast("该优惠券已过期，请左滑删除"),!1):(c.params.from&&d&&c.coupons[d]&&(b.setItem("COUPON",JSON.stringify(c.coupons[d])),a.back()),!1)}),a("#coupon").on("tap",".ts-delete",function(){var a=this;return c.deleteCoupon(this.getAttribute("data-id"),function(){var c=a.parentNode.parentNode;c.parentNode.removeChild(c),b.toast("优惠券删除成功")}),!1})},renderCoupon:function(c,d){var e=this;if(c.data&&c.data.length){var f=a.now();a.each(c.data,function(a,b){var c=1e3*parseInt(b.coupon_failureDate);f>=c?b.expired=!0:(b.expired=!1,e.coupons[b.coupon_id]=b)})}b.template("coupon","coupon/coupon",{couponData:c.data},d)},deleteCoupon:function(c,d){b.showWaiting(),b.Api.delete_coupon(b.User.get_user_id(),c,function(){b.closeWaiting(),d&&d()},a.noop)},getCoupon:function(a){var c=this;b.Api.get_coupon_list({user_id:b.User.get_user_id(),current:c.current,size:c.size},function(c){return c.return_code?void b.error(c.data):void(a&&a(c))})},initPullRefresh:function(){var b,c=this;a.init({pullRefresh:{container:"#pullrefresh",down:{callback:function(){c.current=0,c.getCoupon(function(d){c.renderCoupon(d),!b&&(b=a("#pullrefresh").pullRefresh()),b.endPulldownToRefresh(),d.total_count>(c.current+1)*c.size?b.refresh(!0):b.endPullupToRefresh(!0),c.current++})}},up:{auto:!0,callback:function(){c.getCoupon(function(d){c.renderCoupon(d,"append"),!b&&(b=a("#pullrefresh").pullRefresh()),b.endPullupToRefresh(!(d.total_count>(c.current+1)*c.size)),0===c.current&&0===d.total_count||c.current++})}}}})}})}(mui,TS),function(a){a.os.plus&&(TS.CouponPage=TS.CouponPage.extend(a.extend(TS.AppObject,{initPage:function(){var b=this;a.plusReady(function(){"coupon"===plus.webview.currentWebview().id?b.initPullRefresh():(a.init({beforeback:function(){var b=plus.webview.getWebviewById("confirmorder");b&&a.fire(b,"refresh_coupon")}}),plus.webview.currentWebview().append(plus.webview.create("coupon.html?from="+(b.params&&b.params.from||""),"coupon",{top:TS.isStatusbarOffset()?"64px":"44px",bottom:"0"})))})},refresh:function(b){a.fire(plus.webview.getWebviewById("coupon"),"coupon_refresh")},init5plusEvent:function(){var b=this;a.plusReady(function(){"coupon"===plus.webview.currentWebview().id?document.addEventListener("coupon_refresh",function(a){b._refresh()}):document.getElementById("ts_add").addEventListener("tap",function(a){a.detail.gesture.preventDefault(),TS.prompt("请输入优惠券码","请输入优惠券码",function(a){a&&TS.Api.add_coupon(TS.User.get_user_id(),a,function(){b.refresh()})})})})}})))}(mui);