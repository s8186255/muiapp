/*!
 * =====================================================
 * TS v1.0.0 ()
 * =====================================================
 */
!function(a,b){b.SupplierPage=a.Class.extend({params:{},item_price:0,item_id:0,cart_num:0,item_time:0,init:function(){this.initConfig(),this.initPage(),this.initEvent()},initConfig:function(){var a=this;b.backUrl="/",b.handleOpen=function(b,c,d){~b.href.indexOf("cart.html")?a.addOrUpdateCart(function(a){a?c():d&&d()}):c()},document.location.search&&(a.params=b.parseParams(document.location.search),a.params.id&&document.getElementById("ts_cart_num").parentNode.setAttribute("data-href","../cart/cart.html?item_id="+a.params.id)),template.helper("priceFormat",function(a){return parseFloat(a).toFixed(2)}),a.animateEl=document.getElementById("ts_cart_num_animate"),a.animateEl.addEventListener("webkitTransitionEnd",function(){a.animateEl.classList.add("mui-hidden"),a.animateEl.setAttribute("style",""),document.getElementById("ts_cart_num").parentNode.classList.add("pulse")}),a.animatePulseEl=document.getElementById("ts_cart_num").parentNode,a.animatePulseEl.addEventListener("webkitAnimationEnd",function(){a.animatePulseEl.classList.remove("pulse")})},initCart:function(a){var c=this;b.User.isLogin()?b.Api.get_carts(b.User.get_user_id(),b.Location.get_city_id(),this.params.id,function(b){c._initCart(b.data,a)},function(){c._initCart(!1,a)}):c._initCart(!1,a)},_initCart:function(c,d){this.cart=new b.CartClass(a.isArray(c)&&1===c.length&&c[0]||{}),b.debug&&b.d("this.cart.materials:::"+JSON.stringify(this.cart.materials)),d&&d()},addOrUpdateCart:function(a){if(this.cart.user_id=b.User.get_user_id(),this.cart.city_id=b.Location.get_city_id(),this.cart.station=b.Location.get_station_id(),this.cart.item_id=this.item_id,this.cart.material_price<this.item_price)return b.toast("您点的菜还不够餐厅起送标准，请继续点餐"),a(!1),!1;b.showWaiting();var c=this.cart.toObject();return delete c.cart_id,b.Api.add_minus_cart(b.User.get_user_id(),c,function(c){a(!0),b.closeWaiting()},function(){a(!1),b.closeWaiting()}),!0},initPage:function(c,d){var e=parseInt(this.params.id);if(e){var f=this;b.showWaiting(),f.initCart(function(){document.getElementById("price").innerText=f.cart.material_price,b.showWaiting(),c&&c.item_name?(document.title="挑食·火锅送 - "+c.item_name,document.getElementById("ts_title").innerText=c.item_name,document.getElementById("ts_tip").innerText="请提前"+c.item_time+"小时预定，"+c.item_price+"元起送",f.item_price=c.item_price,f.item_id=c.item_id,f.item_time=c.item_time):b.Api.get_item_detail(e,function(a){var b=a.data;document.title="挑食·火锅送 - "+b.item_name,document.getElementById("ts_title").innerText=b.item_name,document.getElementById("ts_tip").innerText="请提前"+b.item_time+"小时预定，"+b.item_price+"元起送",f.item_price=b.item_price,f.item_id=b.item_id,f.item_time=b.item_time});var g={};a.each(f.cart.materials,function(a,b){g[b.id]=b.num}),b.Api.get_item_material(e,function(c){var e=(f.cart.materials,!a.isEmptyObject(g));f.cart_num=0,a.each(c.data,function(b,c){var d=0;e&&a.each(c.material_items,function(a,b){var c=g[b.material_id];c&&(d+=c)}),c.material_num=d,f.cart_num+=d});var h=document.getElementById("ts_cart_num");h.innerText=f.cart_num,h.classList[f.cart_num?"remove":"add"]("mui-hidden"),b.template("category","supplier/category",{materialData:c.data}),b.template("product","supplier/product",{materialData:c.data}),f.renderProduct(),b.closeWaiting(),setTimeout(function(){d&&d()},50)})})}},initEvent:function(){var c=this;a("#category").on("tap","li",function(a){if(!this.classList.contains("mui-active")){var b=this.getAttribute("data-id"),d=document.querySelector("#category li.mui-active");d&&d.classList.remove("mui-active"),this.classList.add("mui-active");var e=document.getElementById("product_active");e.innerHTML=document.getElementById("product_"+b).innerText,e.setAttribute("data-id",this.id),c.renderProduct()}}),a("#product").on("tap",".mui-numbox-btn-plus",function(){return c.addMaterial(this.parentNode),!1}),a("#product").on("tap",".mui-numbox-btn-minus",function(){return c.removeMaterial(this.parentNode),!1}),document.getElementById("confirm").addEventListener("tap",function(){c.addOrUpdateCart(function(d){d&&(b.Site.get_site()?b.open("../confirmorder/confirmorder.html?"+a.param({cart_ids:c.cart.cart_id,item_id:c.params.id,material_price:c.cart.material_price,act_price:c.cart.act_price,cart_service:c.cart.cart_service,item_time:c.item_time})):b.confirm("您尚未设置送餐地址！",function(a){a&&b.open("../sites/sites.html")}))})})},renderProduct:function(){a.each(this.cart.materials,function(a,b){var c=document.getElementById("material_"+b.id+"_num");c&&(c.value=b.num)})},addMaterial:function(a){this.changeMaterial(a,1)},removeMaterial:function(a){this.changeMaterial(a,-1)},changeMaterial:function(a,b){var c=a.querySelector("input"),d=a.getAttribute("data-id"),e=a.getAttribute("data-name"),f=a.getAttribute("data-price"),g=this.cart.addMaterial(d,b,e,f),h=c.value;c.value=g,document.getElementById("price").innerText=this.cart.material_price;var i=document.getElementById(document.getElementById("product_active").getAttribute("data-id")+"_num"),j=parseInt(i.innerText);j=j-h+g,i.innerText=j,i.classList[j?"remove":"add"]("mui-hidden");var k=document.getElementById("ts_cart_num");return this.cart_num=Math.max(this.cart_num+b,0),k.innerText=this.cart_num,k.classList[this.cart_num?"remove":"add"]("mui-hidden"),b>0&&this.runAnimate(c),g},runAnimate:function(c){this.animateEl.classList.remove("mui-hidden");var d=a.offset(c).top+2;this.animateEl.style.top=d+"px",this.animateEl.style.right="35px",this.animateEl.style.webkitTransitionDuration="500ms";var e=b.isStatusbarOffset()?25:5;this.animateEl.style.webkitTransform="translate3d(30px,"+(e-d)+"px,0)"}})}(mui,TS),function(a,b,c){a.os.plus&&(b.SupplierPage=b.SupplierPage.extend(a.extend(b.AppObject,{init:function(){this.initConfig();var c=this;b.handleOpen=function(a,d,e){b.cs(plus.webview.currentWebview()),~a.href.indexOf("cart.html")?c.addOrUpdateCart(function(a){a?d():e&&e()}):d()},a.plusReady(function(){c.initPage()}),this._init5plusEvent(),this.initEvent()},init5plusEvent:function(){var d=this;c.addEventListener("addMaterial",function(a){var b=c.getElementById("material_"+a.detail.id+"_num");b&&d.addMaterial(b.parentNode)}),c.addEventListener("supplier",function(a){d.params.id=a.detail.id,d.initPage(a.detail),b.cs(plus.webview.getLaunchWebview())}),a.plusReady(function(){plus.webview.currentWebview().addEventListener("hide",function(){c.getElementById("ts_title").innerHTML="";var a=c.getElementById("ts_cart_num");a.innerText="0",a.classList.add("mui-hidden"),c.getElementById("ts_tip").innerHTML="",c.getElementById("price").innerHTML="",c.getElementById("product").innerHTML="",c.getElementById("category").innerHTML="",b.c(plus.webview.getLaunchWebview())})})}})))}(mui,TS,document);